name: Manual

on: 
  workflow_dispatch:
    inputs:
      image_name:
        description: "Image name"
        required: true
        default: ${{ github.event.repository.name }}
      host_name:
        description: "Host name"
        required: true
        default: ${{ github.event.repository.name }}
      first_user:
        description: "Name of the first user on the pi"
        required: true
        default: pi
      first_userpass:
        description: "Password of the first user on the pi. WARNING: Sensitive information, use with caution"
        required: true
        default: ${{ secrets.FIRST_USER_PASS }}
      ssh_enabled:
        description: "1 if SSH should be enabled, 0 otherwise"
        required: true
        default: "1"
      wpa_ssid:
        description: "Wi-Fi SSID to connect automatically on first boot. WARNING: Sensitive information, use with caution"
        required: false
        default: ${{ secrets.WPA_SSID }}
      wpa_passphrase:
        description: "Passphrase of Wi-Fi network to connect to. WARNING: Sensitive information, use with caution"
        required: false
        default: ${{ secrets.WPA_PASSPHRASE }}
      wpa_country:
        description: "ISO-3166-1 alpha-2 country code for the country this image will be used in"
        required: false
        default: "US"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Checkout submodules
        uses: textbook/git-checkout-submodule-action@master

      - name: Set up Docker Buildx
        id: buildx
        uses: crazy-max/ghaction-docker-buildx@v1
        with:
          buildx-version: latest
          qemu-version: latest
      
      - name: Build
        env:
          DEFAULT_IMAGE_NAME: ${{ github.event.inputs.image_name }}
          DEFAULT_HOSTNAME: ${{ github.event.inputs.host_name }}
          DEFAULT_FIRST_USER: ${{ github.event.inputs.first_user }}
          DEFAULT_FIRST_USERPASS: ${{ github.event.inputs.first_user_pass }}
          DEFAULT_SSH_ENABLED: ${{ github.event.inputs.ssh_enabled }}
          DEFAULT_WPA_SSID: ${{ github.event.inputs.wpa_ssid }}
          DEFAULT_WPA_PASSPHRASE: ${{ github.event.inputs.wpa_passphrase }}
          DEFAULT_WPA_COUNTRY: ${{ github.event.inputs.wpa_country }}

        run: |
          pushd pi-gen
          trap "popd; exit" INT TERM EXIT
          ./build-docker.sh -c ../config \
            IMAGE_NAME="${DEFAULT_IMAGE_NAME}" \
            HOSTNAME="${DFAULT_HOSTNAME}" \
            FIRST_USER="${DEFAULT_FIRST_USER}" \
            FIRST_USERPASS="${DEFAULT_FIRST_USERPASS}" \
            SSH_ENABLED="${DEFAULT_SSH_ENABLED}" \
            WPA_SSID="${DEFAULT_WPA_SSID}" \
            WPA_PASSPHRASE="${DEFAULT_WPA_PASSPHRASE}" \
            WPA_COUNTRY="${DEFAULT_WPA_COUNTRY}"

      - name: Upload artifacts  
        uses: actions/upload-artifact@v2
        with:
          name: "${{ github.event.repository.name }}-${{ github.sha }}.zip"
          path: 'pi-gen/deploy/*.zip'